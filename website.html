<!DOCTYPE html>
<html lang="ckb" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¦ÛŒØ¦Ø§ÛŒÛŒ Ú©ÙˆØ±Ø¯ÛŒ - Gemini Chat</title>
    <!-- FAVICON: The sun emoji (â˜€ï¸), symbolizing light/knowledge and a central element of the Kurdish identity. -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â˜€ï¸</text></svg>">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General Setup - Black & Gray Aesthetic */
        :root {
            --primary-black: #000000;
            --secondary-gray: #4A4A4A;
            --primary-blue: #007AFF; 
            --background-light: #F2F2F7; 
            --card-background: #FFFFFF;
            --text-dark: #1D1D1F; 
            --border-color: #D1D1D6;
            --bubble-ai: #E5E5EA; 
            --subtle-gray: #6D6D72;
            --warning-red: #FF3B30;
            --chat-bubble-user: #1A1A1A; 
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: var(--background-light); 
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh; /* Use full viewport height */
            color: var(--text-dark);
            font-weight: 500; 
        }

        /* Custom Alert Modal */
        .custom-alert {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .alert-content {
            background: var(--card-background);
            padding: 20px 30px;
            border-radius: 12px;
            text-align: right;
            max-width: 90%;
            direction: rtl;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .alert-title {
            font-weight: 700;
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--warning-red);
        }

        .alert-content p {
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .alert-content button {
            background-color: var(--primary-black);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            float: left; 
            transition: opacity 0.2s;
        }
        .alert-content button:hover {
            opacity: 0.9;
        }

        /* --- RESPONSIVE CONTAINER STYLES --- */
        /* Default/PC/Desktop View (>= 801px) */
        .chat-container, .auth-container {
            width: 95%; 
            max-width: 1200px; /* Max width on large screens */
            height: 100%;
            background-color: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        /* Mobile View (Viewport width <= 800px) */
        @media (max-width: 800px) {
            .chat-container, .auth-container {
                max-width: 100%; 
                width: 100%;
                border-radius: 0; /* Full screen, no rounded corners */
                margin: 0;
                box-shadow: none; /* No shadow for a native app feel */
            }
        }
        /* --- END RESPONSIVE CONTAINER STYLES --- */


        /* AUTH SCREEN STYLES */
        .auth-container {
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
        }

        .auth-card {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); 
            width: 100%;
            max-width: 350px;
        }

        .auth-card h2 {
            margin-bottom: 30px;
            font-size: 26px; 
            font-weight: 700; 
            color: var(--text-dark);
        }

        .auth-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 14px;
            margin-bottom: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 17px; 
            font-weight: 600; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        .google-icon {
            width: 20px;
            height: 20px;
            margin-left: 10px;
            flex-shrink: 0;
            object-fit: contain;
        }
        
        .auth-button:hover {
            opacity: 0.95; 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); 
        }
        .auth-button:active {
            transform: translateY(0); 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
        }

        .google-btn {
            background-color: var(--primary-black); 
            color: white;
            margin-bottom: 30px; 
        }
        
        .anonymous-btn {
            background-color: var(--secondary-gray); 
            color: white;
            border: 1px solid var(--primary-black);
        }

        .separator {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 15px 0;
            color: var(--subtle-gray);
            font-size: 14px;
        }
        .separator::before,
        .separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }
        .separator:not(:empty)::before {
            margin-right: .25em;
        }
        .separator:not(:empty)::after {
            margin-left: .25em;
        }


        /* CHAT HEADER */
        .header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            direction: rtl; 
        }

        .title-group {
            display: flex;
            align-items: center;
        }

        .title-group h1 {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
            margin-right: 10px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            /* Ensure actions wrap nicely on small screens if they overflow */
            flex-wrap: wrap; 
            justify-content: flex-start;
        }
        
        /* Adjust layout for very small screens */
        @media (max-width: 450px) {
            .header-actions {
                width: 100%;
                margin-top: 10px;
            }
            .header {
                flex-direction: column;
                align-items: flex-end; /* Keep main title right-aligned */
            }
        }


        .header-button {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            /* Make buttons take full width of container if layout forces them to wrap */
            flex-grow: 1; 
        }
        
        /* Link Google Button Styling */
        #upgrade-button {
            background-color: transparent; 
            color: var(--primary-blue); 
            border: none;
            padding: 8px 0; 
            text-decoration: underline; 
            font-weight: 500; 
            transition: color 0.2s;
            flex-grow: 0; /* Do not force underline button to take full width */
        }
        #upgrade-button:hover {
            opacity: 1; 
            color: #0056b3; 
        }

        #logout-button {
            background-color: var(--warning-red); 
            color: white;
        }

        #load-history-button {
            background-color: var(--secondary-gray); 
            color: white;
        }
        
        .header-button i {
            margin-left: 5px;
            font-size: 18px;
        }
        .header-button:hover:not(#upgrade-button) {
            opacity: 0.85;
        }

        /* MESSAGE AREA */
        .message-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        /* CHAT MESSAGES */
        .message {
            display: flex;
            align-items: flex-start;
            max-width: 90%;
            direction: rtl; 
        }
        
        .message .icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            flex-shrink: 0;
            font-weight: normal; 
        }

        /* User Bubble/Icon Update */
        .message.user .icon {
            background-color: var(--chat-bubble-user); 
            color: white;
            margin-right: 10px;
            font-family: Arial, sans-serif;
            font-weight: bold;
        }
        .message.ai .icon {
            background-color: var(--bubble-ai);
            color: var(--text-dark);
            margin-left: 10px;
        }

        /* AI Bubble */
        .message.ai .ai-bubble-content {
            background-color: var(--bubble-ai);
            padding: 10px 15px;
            border-radius: 18px;
            border-top-right-radius: 0;
            line-height: 1.4;
            color: var(--text-dark);
            text-align: right;
            direction: rtl;
            display: flex;
            flex-direction: column;
            gap: 8px; 
            max-width: 100%;
        }

        /* User Bubble Update */
        .message.user .text-content {
            background-color: var(--chat-bubble-user); 
            color: white;
            padding: 10px 15px;
            border-radius: 18px;
            border-top-left-radius: 0;
            line-height: 1.4;
            text-align: right;
            direction: rtl;
            max-width: 100%;
        }

        /* TTS Button inside AI bubble */
        .tts-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px 10px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.7); 
            border: 1px solid var(--border-color);
            color: var(--text-dark);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            width: fit-content;
            align-self: flex-start; 
        }
        .tts-button:hover {
            background-color: white;
        }
        .tts-button i {
            font-size: 16px;
            margin-left: 5px;
        }

        /* Loading indicator for TTS */
        .rotating-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* INPUT AREA */
        .input-area {
            border-top: 1px solid var(--border-color);
            padding: 10px 20px;
            display: flex;
            flex-shrink: 0;
            direction: rtl; 
        }

        #user-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 16px;
            resize: none; 
            overflow: auto; 
            max-height: 100px;
            min-height: 40px;
            margin-left: 10px; 
            text-align: right;
            direction: rtl;
            font-family: inherit;
        }

        /* Send Button Update */
        #send-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-black); 
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        #send-button:hover:not(:disabled) {
            background-color: var(--secondary-gray); 
        }
        #send-button:disabled {
            background-color: var(--subtle-gray); 
            cursor: not-allowed;
        }

        /* Footer Info */
        .footer-info {
            padding: 5px 20px;
            font-size: 12px;
            color: var(--subtle-gray);
            text-align: right;
            direction: rtl;
        }
        
    </style>
    <script type="module">
        
        // ------------------ IMAGE ASSETS (Updated Google "G" Logo SVG) ------------------
        const defaultGoogleLogoSvg = `
            <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                <path fill="#4285F4" d="M24 9.5c3.08 0 5.46 1.34 6.74 2.58l5.8-5.8c-3.66-3.41-8.5-5.28-12.54-5.28C11.51 1.0 0 12.51 0 24s11.51 23 24 23c6.91 0 11.45-2.54 15.3-6.42l-5.8-5.8c-2.32 2.32-5.78 3.82-9.5 3.82-7.22 0-13.12-5.9-13.12-13.12s5.9-13.12 13.12-13.12z"/>
                <path fill="#34A853" d="M47.5 24c0-1.77-.15-3.5-.42-5.18H24v10.16h12.8c-.54 2.66-2.18 4.88-4.72 6.36l5.8 5.8c3.58-3.32 5.6-8.2 5.6-14.12z"/>
                <path fill="#FBBC05" d="M10.88 28.5c-.24-1.12-.37-2.31-.37-3.5s.13-2.38.37-3.5L4.85 17.5c-1.8 3.55-2.85 7.63-2.85 11.5s1.05 7.95 2.85 11.5l6.03-4.99z"/>
                <path fill="#EA4335" d="M24 10.92c3.08 0 5.46 1.34 6.74 2.58l5.8-5.8c-3.66-3.41-8.5-5.28-12.54-5.28C11.51 2.42 0 13.93 0 25.42h10.88c0-7.22 5.9-13.12 13.12-13.12z"/>
            </svg>
        `;
        const emptyLogoHtml = defaultGoogleLogoSvg; 

        // ------------------ FIREBASE CONFIGURATION (Provided by User) ------------------
        const userFirebaseConfig = {
            apiKey: "AIzaSyDoTAMAuFm8h9RFWk_C4BnqtwEis-RGor4",
            authDomain: "ai-kurdy.firebaseapp.com",
            projectId: "ai-kurdy",
            storageBucket: "ai-kurdy.firebasestorage.app",
            messagingSenderId: "1071066507145",
            appId: "1:1071066507145:web:46e894ecfab03cecf52358",
            measurementId: "G-044ZEW6C0G"
        };
        
        // ------------------ FIREBASE IMPORTS ------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, linkWithPopup, signInWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ------------------ GLOBAL VARIABLES FROM ENVIRONMENT ------------------
        const appId = 'default-ai-kurdy-app-id'; 
        const firebaseConfig = userFirebaseConfig; 
        const initialAuthToken = null; 

        let app, auth, db;
        let userId = null;
        const WELCOME_MESSAGE_TEXT = 'Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª! Ù…Ù† Ø¦ÛŒØ¦Ø§ÛŒÛŒ Ú©ÙˆØ±Ø¯ÛŒ Ø¬ÛÙ…ÛŒÙ†ÛŒÙ…. Ú†Û†Ù† Ø¯Û•ØªÙˆØ§Ù†Ù… ÛŒØ§Ø±Ù…Û•ØªÛŒØª Ø¨Ø¯Û•Ù…ØŸ';

        
        // ------------------ GEMINI SETUP ------------------
        import { GoogleGenAI } from "https://esm.run/@google/genai";
        // WARNING: Replace this with a secure API key handling method in production!
        const apiKey = "AIzaSyDNc6-bEE5GpFt5uq_nTkQKAZPXjuKiSxx"; 
        let chat = null;

        // ------------------ UI ELEMENTS ------------------
        const chatContainer = document.getElementById('chat-container');
        const authContainer = document.getElementById('auth-container');
        const messageArea = document.getElementById('message-area');
        const inputField = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadHistoryButton = document.getElementById('load-history-button');
        const logoutButton = document.getElementById('logout-button');
        const upgradeButton = document.getElementById('upgrade-button');


        // ------------------ CORE UTILITY FUNCTIONS ------------------
        
        /**
         * @returns {boolean} True if the text contains characters specific to Sorani Kurdish.
         */
        function isKurdishSorani(text) {
            const soraniMarkers = /[\u067E\u0686\u0698\u06AF\u06A4]/; 
            return soraniMarkers.test(text);
        }

        // Helper functions for WAV conversion (left unchanged as they are robust)
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function pcmToWav(pcm16, sampleRate = 24000) {
            const numChannels = 1;
            const bytesPerSample = 2; 
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataLength = pcm16.length * bytesPerSample;

            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            // RIFF chunk
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true); 
            writeString(view, 8, 'WAVE');

            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);  
            view.setUint16(20, 1, true);    
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true);  

            // Data sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true); 
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }


        // Custom function to replace alert()
        function alertMessage(title, message) {
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = 'custom-alert';
            alertDiv.innerHTML = `
                <div class="alert-content">
                    <div class="alert-title">${title}</div>
                    <p>${message}</p>
                    <button onclick="document.getElementById('custom-alert').remove()">Ø¨Ø§Ø´Û•</button>
                </div>
            `;
            document.body.appendChild(alertDiv);
        }

        // ------------------ LLM TTS FEATURE ------------------

        window.playTTS = async (text, ttsButton) => {
            const originalIcon = ttsButton.innerHTML;
            ttsButton.innerHTML = '<i class="material-icons rotating-icon">sync</i> loading...';
            ttsButton.disabled = true;

            const voiceName = "Kore"; 

            const payload = {
                contents: [{
                    parts: [{ text: `Say this text, using the appropriate language and tone: ${text}` }] 
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voiceName }
                        }
                    }
                },
            };
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                let response = null;
                let delay = 1000;
                for (let i = 0; i < 3; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) break;
                    } catch (e) {
                        console.warn(`TTS fetch failed (attempt ${i + 1}). Retrying in ${delay / 1000}s...`, e);
                    }
                    if (i < 2) await new Promise(resolve => setTimeout(resolve, delay *= 2));
                }
                
                if (!response || !response.ok) throw new Error("TTS API call failed after retries.");

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
                    
                    const pcmDataBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmDataBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl); 
                        ttsButton.innerHTML = originalIcon;
                        ttsButton.disabled = false;
                    };

                    audio.onerror = (e) => {
                        console.error("Audio playback error:", e);
                        alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ù„ÛØ¯Ø§Ù†ÛŒ Ø¯Û•Ù†Ú¯', 'Ù†Ø§ØªÙˆØ§Ù†Ø±ÛØª Ø¯Û•Ù†Ú¯Û•Ú©Û• Ù„ÛØ¨Ø¯Ø±ÛØª. Ú•Û•Ù†Ú¯Û• ÙÛ†Ø±Ù…Ø§ØªÛ•Ú©Û• Ú©ÛØ´Û•ÛŒ Ù‡Û•Ø¨ÛØª.');
                        ttsButton.innerHTML = originalIcon;
                        ttsButton.disabled = false;
                    };
                    
                } else {
                    console.error("Invalid TTS response structure or missing audio data.", result);
                    alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ø¯Û•Ù†Ú¯', 'Ù‡ÛŒÚ† Ø¯Û•Ù†Ú¯ÛÚ© Ù†Û•Ø¯Û†Ø²Ø±Ø§ÛŒÛ•ÙˆÛ• ÛŒØ§Ù† ÙÛ†Ø±Ù…Ø§ØªÛ•Ú©Û• Ù‡Û•ÚµÛ•ÛŒÛ•.');
                }
            } catch (error) {
                console.error("TTS generation error:", error);
                alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ú¯Ø´ØªÛŒ', 'Ú©ÛØ´Û•ÛŒÛ•Ú© Ù„Û• Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ Ø¯Û•Ù†Ú¯Û•Ú©Û• Ú•ÙˆÙˆÛŒØ¯Ø§. Ù‡Û†Ú©Ø§Ø±: ' + error.message);
            } finally {
                if (ttsButton.disabled && ttsButton.innerHTML.includes('sync')) {
                    ttsButton.innerHTML = originalIcon;
                    ttsButton.disabled = false;
                }
            }
        };


        // ------------------ FIREBASE INITIALIZATION ------------------
        function initializeFirebase() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is missing or incomplete. Authentication will not work.");
                document.getElementById('auth-error').textContent = "Ù‡Û•ÚµÛ•: Ú•ÛÚ©Ø®Ø³ØªÙ†Û•Ú©Ø§Ù†ÛŒ ÙØ§ÛŒÛ•Ø±Ø¨Û•ÛŒØ³ Ù†Ø§Ø¯Ø±ÙˆØ³ØªÙ†.";
                return;
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            setupAuthListener();
            handleInitialAuth();
        }

        async function handleInitialAuth() {
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Custom token sign-in failed (system environment issue). User must now choose sign-in method.", error);
                }
            }
        }

        // ------------------ AUTHENTICATION METHODS ------------------
        
        window.logout = async () => {
            try {
                await signOut(auth);
                alertMessage('Ú†ÙˆÙˆÙ†Û•Ø¯Û•Ø±Û•ÙˆÛ• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ø¨ÙˆÙˆ', 'Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ù„Û• Ù‡Û•Ú˜Ù…Ø§Ø±Û•Ú©Û•Øª Ú†ÙˆÙˆÛŒØªÛ• Ø¯Û•Ø±Û•ÙˆÛ•.');
            } catch (error) {
                console.error("Logout failed:", error);
                alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ú†ÙˆÙˆÙ†Û•Ø¯Û•Ø±Û•ÙˆÛ•', `Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ù„Û• Ù‡Û•Ú˜Ù…Ø§Ø±Û•Ú©Û• Ø¨Ú†ÛŒØªÛ• Ø¯Û•Ø±Û•ÙˆÛ•: ${error.message}`);
            }
        };

        window.signInWithGoogle = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•', `Ù‡Û•ÚµÛ•ÛŒ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•ÛŒ Ú¯ÙˆÙˆÚ¯Úµ: ${error.message}`);
            }
        };

        window.signInAnonymouslyUser = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Anonymous Sign-In failed:", error);
                alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•', `Ù‡Û•ÚµÛ•ÛŒ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•ÛŒ Ø¨ÛÙ†Ø§Ùˆ: ${error.message}`);
            }
        };

        /**
         * Attempts to link an anonymous account to Google, handling the credential-already-in-use error.
         */
        window.upgradeToGoogle = async () => {
            if (!auth.currentUser || !auth.currentUser.isAnonymous) {
                alertMessage('Ù‡Û•ÚµÛ•', 'ØªÛ•Ù†Ù‡Ø§ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±Ø§Ù†ÛŒ Ø¨ÛÙ†Ø§Ùˆ Ø¯Û•ØªÙˆØ§Ù†Ù† Ø¦Û•Ú©Ø§ÙˆÙ†ØªÛŒØ§Ù† Ø¨Û•Ø±Ø² Ø¨Ú©Û•Ù†Û•ÙˆÛ•.');
                return;
            }

            try {
                const provider = new GoogleAuthProvider();
                // 1. Attempt to link the current anonymous user to a new Google account
                await linkWithPopup(auth.currentUser, provider);
                alertMessage('Ø¨Û•Ø³ØªÙ†Û•ÙˆÛ• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ø¨ÙˆÙˆ', 'Ù‡Û•Ú˜Ù…Ø§Ø±ÛŒ Ø¨ÛÙ†Ø§ÙˆÛŒ Ø¦ÛØ³ØªØ§Øª Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ø¨Û•Ø³ØªØ±Ø§ÙˆÛ•ØªÛ•ÙˆÛ• Ø¨Û• Ú¯ÙˆÙˆÚ¯Úµ.');
                
            } catch (error) {
                console.error("Account upgrade failed:", error);

                // Check for the specific error: auth/credential-already-in-use
                if (error.code === 'auth/credential-already-in-use' && error.credential) {
                    
                    // 2. The credential is used by another existing account.
                    const credential = error.credential;
                    
                    try {
                        // 3. Sign the user in with the conflicting credential. This effectively 
                        //    migrates the session from the anonymous account to the persistent account.
                        await signInWithCredential(auth, credential);
                        
                        alertMessage(
                            'Ù„ÛŒÙ†Ú©Ú©Ø±Ø¯Ù† Ùˆ Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ø¨ÙˆÙˆ',
                            'Ø¦Û•Ù… Ø¦Û•Ú©Ø§ÙˆÙ†ØªÛ•ÛŒ Ú¯ÙˆÙˆÚ¯Úµ Ù¾ÛØ´ØªØ± Ø¨Û•Ú©Ø§Ø±Ù‡Ø§ØªØ¨ÙˆÙˆ. Ø¦ÛØ³ØªØ§ Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ Ú†ÙˆÙˆÛŒØªÛ• Ú˜ÙˆÙˆØ±Û•ÙˆÛ• Ùˆ Ú†ÛŒØªØ± Ø¨ÛÙ†Ø§Ùˆ Ù†ÛŒØª.'
                        );
                    } catch (signInError) {
                         console.error("Failed to sign in with conflicting credential:", signInError);
                         alertMessage(
                            'Ù‡Û•ÚµÛ•ÛŒ Ø¨Û•Ø³ØªÙ†Û•ÙˆÛ•', 
                            `Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ø¦Û•Ú©Ø§ÙˆÙ†ØªÛ• Ø¨Û•Ø³ØªØ±Ø§ÙˆÛ•Ú©Û• Ø¨Û•Ú©Ø§Ø± Ø¨Ù‡ÛÙ†Ø±ÛØª Ø¨Û† Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•: ${signInError.message}`
                        );
                    }
                    
                } else {
                    // Handle other errors (e.g., popup closed, network error)
                    alertMessage('Ù‡Û•ÚµÛ•ÛŒ Ø¨Û•Ø³ØªÙ†Û•ÙˆÛ•', `Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ø¦Û•Ú©Ø§ÙˆÙ†ØªÛŒ Ú¯ÙˆÙˆÚ¯Úµ Ø¨Ø¨Û•Ø³ØªØ±ÛØªÛ•ÙˆÛ•: ${error.message}`);
                }
            }
        };
        
        /**
         * Checks if the user is a persistent user (i.e., NOT anonymous). This includes Google users.
         */
        function isPersistentUser(user) {
            return user && !user.isAnonymous;
        }

        // ------------------ AUTH STATE LISTENER & UI MANAGEMENT ------------------
        function setupAuthListener() {
            let initialLoadDone = false; // Flag to control chat/history initialization

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    showAuthScreen(false);
                    
                    const isAnonymous = user.isAnonymous;
                    const isPersistent = isPersistentUser(user);
                    
                    // --- UPDATED LOGIC FOR USER DISPLAY ---
                    if (isPersistent && user.email) {
                        userIdDisplay.textContent = `Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ• Ø¨Û•: ${user.email} (Ø¨Û•Ø±Ø¯Û•ÙˆØ§Ù…)`;
                    } else if (isAnonymous) {
                        // For anonymous users, show the ID and status
                        userIdDisplay.textContent = `Ù†Ø§Ø³Ù†Ø§Ù…Û•ÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±: ${userId} (Ø¨ÛÙ†Ø§Ùˆ)`;
                    } else {
                         // Fallback for other persistent types
                        userIdDisplay.textContent = `Ù†Ø§Ø³Ù†Ø§Ù…Û•ÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±: ${userId} (Ø¨Û•Ø±Ø¯Û•ÙˆØ§Ù…)`;
                    }
                    // --- END UPDATED LOGIC ---


                    // Manage Header Buttons based on persistence
                    if (isPersistent) {
                        // User is signed in with Google (or another persistent method)
                        logoutButton.style.display = 'flex';
                        upgradeButton.style.display = 'none';
                        toggleHistoryButton(true); 
                    } else if (isAnonymous) {
                        // User is signed in anonymously
                        logoutButton.style.display = 'none';
                        upgradeButton.style.display = 'flex'; 
                        toggleHistoryButton(false); 
                    } else {
                        // Fallback 
                        logoutButton.style.display = 'flex';
                        upgradeButton.style.display = 'none';
                        toggleHistoryButton(true);
                    }

                    // Only run initializeChat on first load/change, not on every state check if already initialized
                    if (!initialLoadDone || userId !== chat?.userId) {
                        initializeChat(user);
                        initialLoadDone = true;
                    }

                } else {
                    userId = null;
                    // Reset to the default message when logged out
                    userIdDisplay.textContent = 'Ù†Ø§Ø³Ù†Ø§Ù…Û•ÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±: Ø¨ÛÙ†Ø§Ùˆ';
                    showAuthScreen(true);
                    
                    if(logoutButton) logoutButton.style.display = 'none';
                    if(upgradeButton) upgradeButton.style.display = 'none';
                    
                    // Reset flag on logout
                    initialLoadDone = false;
                }
            });
        }

        function showAuthScreen(show) {
            authContainer.style.display = show ? 'flex' : 'none';
            chatContainer.style.display = show ? 'none' : 'flex';
        }
        
        function toggleHistoryButton(show) {
            if (loadHistoryButton) {
                loadHistoryButton.style.display = show ? 'flex' : 'none'; 
            }
        }


        // ------------------ FIRESTORE HISTORY LOGIC ------------------

        function getChatCollectionRef() {
            const collectionName = 'chat_history';
            // History is stored publicly for persistence across Google sessions
            const publicPath = `/artifacts/${appId}/public/data/${collectionName}`; 
            return collection(db, publicPath);
        }

        function loadChatHistory() {
            // Only load history where the userId matches the current persistent user
            if (!isPersistentUser(auth.currentUser)) return;

            const q = query(
                getChatCollectionRef(),
                where('userId', '==', userId)
            );

            onSnapshot(q, (snapshot) => {
                // Clear the message area for the new history load
                messageArea.innerHTML = ''; 
                // Add the initial welcome message first
                appendMessage('ai', WELCOME_MESSAGE_TEXT, false, false); 

                let chatMessages = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.timestamp && data.text && data.text !== WELCOME_MESSAGE_TEXT) {
                         chatMessages.push({ ...data, id: doc.id });
                    }
                });
                
                chatMessages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

                chatMessages.forEach(msg => {
                    appendMessage(msg.role, msg.text, false, true); 
                });
                messageArea.scrollTop = messageArea.scrollHeight;
            }, (error) => {
                console.error("Error loading chat history:", error);
            });
        }


        // ------------------ GEMINI CHAT LOGIC ------------------

        function initializeChat(user) {
            chat = new GoogleGenAI({ apiKey }).chats.create({ 
                model: "gemini-2.5-flash", 
                systemInstruction: "You are a helpful, conversational AI assistant. You should primarily respond in the language the user is speaking, or the language requested by the user. Maintain a polite and helpful tone.",
                config: {
                    tools: [{ google_search: {} }]
                }
            });
            chat.userId = user.uid; // Store the user ID on the chat object

            messageArea.innerHTML = '';
            // Welcome message does NOT need a TTS button
            appendMessage('ai', WELCOME_MESSAGE_TEXT, false, false);

            inputField.disabled = false;
            sendButton.disabled = false;
            inputField.focus();

            const isPersistent = isPersistentUser(auth.currentUser);
            
            // Set up history button only if authorized (Persistent user: Google, Custom, etc.)
            if (db && isPersistent) {
                loadHistoryButton.onclick = loadChatHistory; 
                // Automatically load history on login for persistent users
                loadHistoryButton.style.display = 'flex'; // Ensure button visibility is set here too
                loadChatHistory();
            } else {
                 loadHistoryButton.style.display = 'none'; // Hide for anonymous
            }

            sendButton.onclick = sendMessage;
            inputField.onkeypress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); 
                    sendMessage();
                }
            };
        }

        /**
         * Function to create and append a new message to the chat.
         */
        function appendMessage(sender, text, scroll = true, showTtsButton = true) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            
            const iconHTML = sender === 'ai' ? '<div class="icon">ğŸ¤–</div>' : '<div class="icon">Øª</div>';
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('text-content');
            contentDiv.innerHTML = text; 

            if (sender === 'ai') {
                
                // CONDITIONAL TTS LOGIC
                const isKurdish = isKurdishSorani(text);
                // TTS is NOT shown if the text is identified as Sorani Kurdish (since the voice model isn't Kurdi)
                const shouldShowFinalTTS = showTtsButton && !isKurdish; 
                
                const bubbleContent = document.createElement('div');
                bubbleContent.classList.add('ai-bubble-content');
                
                bubbleContent.appendChild(contentDiv);

                if (shouldShowFinalTTS) {
                    const ttsButton = document.createElement('button');
                    ttsButton.classList.add('tts-button');
                    ttsButton.innerHTML = '<i class="material-icons">volume_up</i> âœ¨Ú¯ÙˆÛÚ¯Ø±ØªÙ†';
                    ttsButton.title = 'Ú¯ÙˆÛÚ¯Ø±ØªÙ† Ø¨Û• Ø¯Û•Ù†Ú¯ÛŒ Ø¬ÛÙ…ÛŒÙ†ÛŒ';

                    ttsButton.onclick = () => window.playTTS(text, ttsButton);
                    
                    bubbleContent.appendChild(ttsButton);
                }

                messageDiv.innerHTML = iconHTML;
                messageDiv.appendChild(bubbleContent);
                messageDiv.style.alignSelf = 'flex-start'; 
                
            } else {
                 messageDiv.innerHTML = contentDiv.outerHTML + iconHTML;
                 messageDiv.style.flexDirection = 'row-reverse';
                 messageDiv.style.alignSelf = 'flex-end';
            }
            
            messageArea.appendChild(messageDiv);
            if (scroll) {
                messageArea.scrollTop = messageArea.scrollHeight;
            }
            return contentDiv;
        }

        async function sendMessage() {
            const prompt = inputField.value.trim();
            if (prompt === "" || !chat) return;
            
            const isPersistent = isPersistentUser(auth.currentUser);

            // 1. Add user message to the UI
            appendMessage('user', prompt);
            inputField.value = '';
            inputField.disabled = true;
            sendButton.disabled = true;

            // 1.5. SAVE USER MESSAGE TO FIRESTORE (Only for persistent users, e.g., Google users)
            if (userId && db && isPersistent) {
                 try {
                     await addDoc(getChatCollectionRef(), {
                         userId: userId,
                         role: 'user',
                         text: prompt,
                         timestamp: serverTimestamp()
                     });
                 } catch (e) {
                     console.error("Error adding user message to history:", e);
                 }
            }


            // 2. Add a loading indicator for the AI's response
            const aiMessageContent = appendMessage('ai', '...');
            let aiResponseText = '';
            
            try {
                // 3. Call the Gemini API 
                const response = await chat.sendMessage({ message: prompt });
                aiResponseText = response.text;
                
                // --- Re-check language and re-render the message bubble if the TTS button is needed/not needed ---
                const isKurdish = isKurdishSorani(aiResponseText);
                const shouldShowFinalTTS = !isKurdish;

                // Create a new temporary element to rebuild the AI message content correctly
                const tempDiv = document.createElement('div');
                tempDiv.classList.add('ai-bubble-content');

                const newTextContent = document.createElement('div');
                newTextContent.classList.add('text-content');
                newTextContent.innerHTML = aiResponseText;
                tempDiv.appendChild(newTextContent);

                if (shouldShowFinalTTS) {
                    const ttsButton = document.createElement('button');
                    ttsButton.classList.add('tts-button');
                    ttsButton.innerHTML = '<i class="material-icons">volume_up</i> âœ¨Ú¯ÙˆÛÚ¯Ø±ØªÙ†';
                    ttsButton.title = 'Ú¯ÙˆÛÚ¯Ø±ØªÙ† Ø¨Û• Ø¯Û•Ù†Ú¯ÛŒ Ø¬ÛÙ…ÛŒÙ†ÛŒ';
                    ttsButton.onclick = () => window.playTTS(aiResponseText, ttsButton);
                    tempDiv.appendChild(ttsButton);
                }

                // Find the parent message container and replace its content
                const parentMessage = aiMessageContent.closest('.message');
                const existingBubble = aiMessageContent.closest('.ai-bubble-content');
                
                if (parentMessage && existingBubble) {
                    // Replace the existing bubble content with the finalized one
                    existingBubble.replaceWith(tempDiv);
                } else {
                    aiMessageContent.innerHTML = aiResponseText;
                }
                // ------------------------------------------------------------------------------------------------


                // 4.5. SAVE AI MESSAGE TO FIRESTORE
                if (userId && db && isPersistent) {
                      try {
                          await addDoc(getChatCollectionRef(), {
                              userId: userId,
                              role: 'ai',
                              text: aiResponseText,
                              timestamp: serverTimestamp()
                          });
                      } catch (e) {
                          console.error("Error adding AI message to history:", e);
                      }
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                aiMessageContent.innerHTML = '<strong>Ù‡Ù‡â€ŒÚµÙ‡â€Œ:</strong> Ø¨Ø¨ÙˆØ±Ù‡â€ŒØŒ Ù¾Ù‡â€ŒÛŒÙˆÙ‡â€ŒÙ†Ø¯ÛŒ Ù„Ù‡â€ŒÚ¯Ù‡â€ŒÚµ Ø¬ÛÙ…ÛŒÙ†ÛŒ Ù¾Ú†Ú•Ø§. Ø³Ù‡â€ŒÛŒØ±ÛŒ Ú©Û†Ù†Ø³Û†ÚµÛ•Ú©Û• Ø¨Ú©Ù‡â€Œ Ø¨Û† Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ø²ÛŒØ§ØªØ±.';
            } finally {
                // 5. Re-enable input
                inputField.disabled = false;
                sendButton.disabled = false;
                inputField.focus();
                messageArea.scrollTop = messageArea.scrollHeight;
            }
        }

        // Start the application after the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const placeholder = document.getElementById('google-icon-placeholder');
            if (placeholder) {
                placeholder.innerHTML = emptyLogoHtml;
            }
            initializeFirebase();
        });

    </script>
</head>
<body>

    <!-- Authentication Screen (Hidden by default, shown when logged out) -->
    <div id="auth-container" class="auth-container" style="display: none;">
        <div class="auth-card">
            <h2>Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ• Ø¨Û† Ø¦ÛŒØ¦Ø§ÛŒÛŒ Ú©ÙˆØ±Ø¯ÛŒ</h2>
            
            <!-- Google Sign-In -->
            <button id="google-sign-in" onclick="signInWithGoogle()" class="auth-button google-btn">
                Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ• Ø¨Û• Ú¯ÙˆÙˆÚ¯Úµ
                <span id="google-icon-placeholder"></span>
            </button>

            <div class="separator">ÛŒØ§Ø®ÙˆØ¯</div>
            
            <!-- Anonymous Sign-In -->
            <button id="anonymous-sign-in" onclick="signInAnonymouslyUser()" class="auth-button anonymous-btn">
                Ø¨Û• Ø¨ÛÙ†Ø§Ùˆ Ø¨Ú†Û† Ú˜ÙˆÙˆØ±Û•ÙˆÛ• (Ø¨Û Ù¾Ø§Ø´Û•Ú©Û•ÙˆØªÛŒ Ú†Ø§Øª)
            </button>
            <p id="auth-error" class="text-xs text-red-500 mt-2"></p>
        </div>
    </div>


    <!-- Chat Interface (Hidden by default, shown when logged in) -->
    <div id="chat-container" class="chat-container" style="display: none;">
        
        <!-- Header/Toolbar -->
        <div class="header">
            <div class="title-group">
                <h1>Ø¦ÛŒØ¦Ø§ÛŒÛŒ Ú©ÙˆØ±Ø¯ÛŒ</h1>
                <div class="icon">â˜€ï¸</div>
            </div>
            <div class="header-actions">
                <!-- Link Google Button (Visible for Anonymous users) -->
                <button id="upgrade-button" onclick="upgradeToGoogle()" class="header-button" style="display: none;">
                    <i class="material-icons">link</i>
                    Ø¨Û•Ø³ØªÙ†Û•ÙˆÛ• Ø¨Û• Ú¯ÙˆÙˆÚ¯Úµ
                </button>
                
                <!-- Load History Button (Visible for Persistent users, including Google users) -->
                <button id="load-history-button" class="header-button" style="display: none;">
                    <i class="material-icons">history</i>
                    Ø¨Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ Ù…ÛÚ˜ÙˆÙˆ
                </button>

                <!-- Logout Button (Visible for Persistent users, including Google users) -->
                <button id="logout-button" onclick="logout()" class="header-button" style="display: none;">
                    <i class="material-icons">logout</i>
                    Ú†ÙˆÙˆÙ†Û•Ø¯Û•Ø±Û•ÙˆÛ•
                </button>
            </div>
        </div>

        <!-- Message Display Area -->
        <div id="message-area" class="message-area">
            <!-- Chat messages will be appended here by JavaScript -->
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <textarea id="user-input" rows="1" placeholder="Ù†Ø§Ù…Û•Ú©Û•Øª Ù„ÛØ±Û• Ø¨Ù†ÙˆÙˆØ³Û•..."></textarea>
            <button id="send-button" disabled>
                <i class="material-icons">send</i>
            </button>
        </div>
        
        <!-- Footer/Status Info -->
        <div class="footer-info">
            <span id="user-id-display">Ù†Ø§Ø³Ù†Ø§Ù…Û•ÛŒ Ø¨Û•Ú©Ø§Ø±Ù‡ÛÙ†Û•Ø±: Ø¨ÛÙ†Ø§Ùˆ</span> |
            <span>Ú¯Û•Ø´Û•Ù¾ÛØ¯Ø±Ø§Ùˆ Ù„Û•Ú¯Û•Úµ Gemini & Firebase</span>
        </div>

    </div>
</body>
</html>
